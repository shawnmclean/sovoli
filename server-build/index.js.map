{
  "version": 3,
  "sources": ["../server/index.ts"],
  "sourcesContent": ["import crypto from 'crypto'\r\nimport { createRequestHandler as _createRequestHandler } from '@remix-run/express'\r\nimport { type ServerBuild, installGlobals } from '@remix-run/node'\r\nimport * as Sentry from '@sentry/remix'\r\nimport { ip as ipAddress } from 'address'\r\nimport chalk from 'chalk'\r\nimport closeWithGrace from 'close-with-grace'\r\nimport compression from 'compression'\r\nimport express from 'express'\r\nimport rateLimit from 'express-rate-limit'\r\nimport getPort, { portNumbers } from 'get-port'\r\nimport helmet from 'helmet'\r\nimport morgan from 'morgan'\r\n\r\ninstallGlobals()\r\n\r\nconst MODE = process.env.NODE_ENV ?? 'development'\r\nconst IS_PROD = MODE === 'production'\r\nconst IS_DEV = MODE === 'development'\r\nconst ALLOW_INDEXING = process.env.ALLOW_INDEXING !== 'false'\r\n\r\nconst createRequestHandler = IS_PROD\r\n\t? Sentry.wrapExpressCreateRequestHandler(_createRequestHandler)\r\n\t: _createRequestHandler\r\n\r\nconst viteDevServer = IS_PROD\r\n\t? undefined\r\n\t: await import('vite').then(vite =>\r\n\t\t\tvite.createServer({\r\n\t\t\t\tserver: { middlewareMode: true },\r\n\t\t\t}),\r\n\t\t)\r\n\r\nconst app = express()\r\n\r\nconst getHost = (req: { get: (key: string) => string | undefined }) =>\r\n\treq.get('X-Forwarded-Host') ?? req.get('host') ?? ''\r\n\r\n// fly is our proxy\r\napp.set('trust proxy', true)\r\n\r\n// ensure HTTPS only (X-Forwarded-Proto comes from Fly)\r\napp.use((req, res, next) => {\r\n\tconst proto = req.get('X-Forwarded-Proto')\r\n\tconst host = getHost(req)\r\n\tif (proto === 'http') {\r\n\t\tres.set('X-Forwarded-Proto', 'https')\r\n\t\tres.redirect(`https://${host}${req.originalUrl}`)\r\n\t\treturn\r\n\t}\r\n\tnext()\r\n})\r\n\r\n// no ending slashes for SEO reasons\r\n// https://github.com/epicweb-dev/epic-stack/discussions/108\r\napp.get('*', (req, res, next) => {\r\n\tif (req.path.endsWith('/') && req.path.length > 1) {\r\n\t\tconst query = req.url.slice(req.path.length)\r\n\t\tconst safepath = req.path.slice(0, -1).replace(/\\/+/g, '/')\r\n\t\tres.redirect(302, safepath + query)\r\n\t} else {\r\n\t\tnext()\r\n\t}\r\n})\r\n\r\napp.use(compression())\r\n\r\n// http://expressjs.com/en/advanced/best-practice-security.html#at-a-minimum-disable-x-powered-by-header\r\napp.disable('x-powered-by')\r\n\r\napp.use(Sentry.Handlers.requestHandler())\r\napp.use(Sentry.Handlers.tracingHandler())\r\n\r\nif (viteDevServer) {\r\n\tapp.use(viteDevServer.middlewares)\r\n} else {\r\n\t// Remix fingerprints its assets so we can cache forever.\r\n\tapp.use(\r\n\t\t'/assets',\r\n\t\texpress.static('build/client/assets', { immutable: true, maxAge: '1y' }),\r\n\t)\r\n\r\n\t// Everything else (like favicon.ico) is cached for an hour. You may want to be\r\n\t// more aggressive with this caching.\r\n\tapp.use(express.static('build/client', { maxAge: '1h' }))\r\n}\r\n\r\napp.get(['/img/*', '/favicons/*'], (_req, res) => {\r\n\t// if we made it past the express.static for these, then we're missing something.\r\n\t// So we'll just send a 404 and won't bother calling other middleware.\r\n\treturn res.status(404).send('Not found')\r\n})\r\n\r\nmorgan.token('url', req => decodeURIComponent(req.url ?? ''))\r\napp.use(\r\n\tmorgan('tiny', {\r\n\t\tskip: (req, res) =>\r\n\t\t\tres.statusCode === 200 &&\r\n\t\t\t(req.url?.startsWith('/resources/note-images') ||\r\n\t\t\t\treq.url?.startsWith('/resources/user-images') ||\r\n\t\t\t\treq.url?.startsWith('/resources/healthcheck')),\r\n\t}),\r\n)\r\n\r\napp.use((_, res, next) => {\r\n\tres.locals.cspNonce = crypto.randomBytes(16).toString('hex')\r\n\tnext()\r\n})\r\n\r\napp.use(\r\n\thelmet({\r\n\t\txPoweredBy: false,\r\n\t\treferrerPolicy: { policy: 'same-origin' },\r\n\t\tcrossOriginEmbedderPolicy: false,\r\n\t\tcontentSecurityPolicy: {\r\n\t\t\t// NOTE: Remove reportOnly when you're ready to enforce this CSP\r\n\t\t\treportOnly: true,\r\n\t\t\tdirectives: {\r\n\t\t\t\t'connect-src': [\r\n\t\t\t\t\tMODE === 'development' ? 'ws:' : null,\r\n\t\t\t\t\tprocess.env.SENTRY_DSN ? '*.sentry.io' : null,\r\n\t\t\t\t\t\"'self'\",\r\n\t\t\t\t].filter(Boolean),\r\n\t\t\t\t'font-src': [\"'self'\"],\r\n\t\t\t\t'frame-src': [\"'self'\"],\r\n\t\t\t\t'img-src': [\"'self'\", 'data:'],\r\n\t\t\t\t'script-src': [\r\n\t\t\t\t\t\"'strict-dynamic'\",\r\n\t\t\t\t\t\"'self'\",\r\n\t\t\t\t\t// @ts-expect-error\r\n\t\t\t\t\t(_, res) => `'nonce-${res.locals.cspNonce}'`,\r\n\t\t\t\t],\r\n\t\t\t\t'script-src-attr': [\r\n\t\t\t\t\t// @ts-expect-error\r\n\t\t\t\t\t(_, res) => `'nonce-${res.locals.cspNonce}'`,\r\n\t\t\t\t],\r\n\t\t\t\t'upgrade-insecure-requests': null,\r\n\t\t\t},\r\n\t\t},\r\n\t}),\r\n)\r\n\r\n// When running tests or running in development, we want to effectively disable\r\n// rate limiting because playwright tests are very fast and we don't want to\r\n// have to wait for the rate limit to reset between tests.\r\nconst maxMultiple =\r\n\t!IS_PROD || process.env.PLAYWRIGHT_TEST_BASE_URL ? 10_000 : 1\r\nconst rateLimitDefault = {\r\n\twindowMs: 60 * 1000,\r\n\tmax: 1000 * maxMultiple,\r\n\tstandardHeaders: true,\r\n\tlegacyHeaders: false,\r\n\t// Fly.io prevents spoofing of X-Forwarded-For\r\n\t// so no need to validate the trustProxy config\r\n\tvalidate: { trustProxy: false },\r\n}\r\n\r\nconst strongestRateLimit = rateLimit({\r\n\t...rateLimitDefault,\r\n\twindowMs: 60 * 1000,\r\n\tmax: 10 * maxMultiple,\r\n})\r\n\r\nconst strongRateLimit = rateLimit({\r\n\t...rateLimitDefault,\r\n\twindowMs: 60 * 1000,\r\n\tmax: 100 * maxMultiple,\r\n})\r\n\r\nconst generalRateLimit = rateLimit(rateLimitDefault)\r\napp.use((req, res, next) => {\r\n\tconst strongPaths = [\r\n\t\t'/login',\r\n\t\t'/signup',\r\n\t\t'/verify',\r\n\t\t'/admin',\r\n\t\t'/onboarding',\r\n\t\t'/reset-password',\r\n\t\t'/settings/profile',\r\n\t\t'/resources/login',\r\n\t\t'/resources/verify',\r\n\t]\r\n\tif (req.method !== 'GET' && req.method !== 'HEAD') {\r\n\t\tif (strongPaths.some(p => req.path.includes(p))) {\r\n\t\t\treturn strongestRateLimit(req, res, next)\r\n\t\t}\r\n\t\treturn strongRateLimit(req, res, next)\r\n\t}\r\n\r\n\t// the verify route is a special case because it's a GET route that\r\n\t// can have a token in the query string\r\n\tif (req.path.includes('/verify')) {\r\n\t\treturn strongestRateLimit(req, res, next)\r\n\t}\r\n\r\n\treturn generalRateLimit(req, res, next)\r\n})\r\n\r\nasync function getBuild() {\r\n\tconst build = viteDevServer\r\n\t\t? viteDevServer.ssrLoadModule('virtual:remix/server-build')\r\n\t\t: // @ts-ignore this should exist before running the server\r\n\t\t\t// but it may not exist just yet.\r\n\t\t\tawait import('../build/server/index.js')\r\n\t// not sure how to make this happy \uD83E\uDD37\u200D\u2642\uFE0F\r\n\treturn build as unknown as ServerBuild\r\n}\r\n\r\nif (!ALLOW_INDEXING) {\r\n\tapp.use((_, res, next) => {\r\n\t\tres.set('X-Robots-Tag', 'noindex, nofollow')\r\n\t\tnext()\r\n\t})\r\n}\r\n\r\napp.all(\r\n\t'*',\r\n\tcreateRequestHandler({\r\n\t\tgetLoadContext: (_: any, res: any) => ({\r\n\t\t\tcspNonce: res.locals.cspNonce,\r\n\t\t\tserverBuild: getBuild(),\r\n\t\t}),\r\n\t\tmode: MODE,\r\n\t\tbuild: getBuild,\r\n\t}),\r\n)\r\n\r\nconst desiredPort = Number(process.env.PORT || 3000)\r\nconst portToUse = await getPort({\r\n\tport: portNumbers(desiredPort, desiredPort + 100),\r\n})\r\nconst portAvailable = desiredPort === portToUse\r\nif (!portAvailable && !IS_DEV) {\r\n\tconsole.log(`\u26A0\uFE0F Port ${desiredPort} is not available.`)\r\n\tprocess.exit(1)\r\n}\r\n\r\nconst server = app.listen(portToUse, () => {\r\n\tif (!portAvailable) {\r\n\t\tconsole.warn(\r\n\t\t\tchalk.yellow(\r\n\t\t\t\t`\u26A0\uFE0F  Port ${desiredPort} is not available, using ${portToUse} instead.`,\r\n\t\t\t),\r\n\t\t)\r\n\t}\r\n\tconsole.log(`\uD83D\uDE80  We have liftoff!`)\r\n\tconst localUrl = `http://localhost:${portToUse}`\r\n\tlet lanUrl: string | null = null\r\n\tconst localIp = ipAddress() ?? 'Unknown'\r\n\t// Check if the address is a private ip\r\n\t// https://en.wikipedia.org/wiki/Private_network#Private_IPv4_address_spaces\r\n\t// https://github.com/facebook/create-react-app/blob/d960b9e38c062584ff6cfb1a70e1512509a966e7/packages/react-dev-utils/WebpackDevServerUtils.js#LL48C9-L54C10\r\n\tif (/^10[.]|^172[.](1[6-9]|2[0-9]|3[0-1])[.]|^192[.]168[.]/.test(localIp)) {\r\n\t\tlanUrl = `http://${localIp}:${portToUse}`\r\n\t}\r\n\r\n\tconsole.log(\r\n\t\t`\r\n${chalk.bold('Local:')}            ${chalk.cyan(localUrl)}\r\n${lanUrl ? `${chalk.bold('On Your Network:')}  ${chalk.cyan(lanUrl)}` : ''}\r\n${chalk.bold('Press Ctrl+C to stop')}\r\n\t\t`.trim(),\r\n\t)\r\n})\r\n\r\ncloseWithGrace(async () => {\r\n\tawait new Promise((resolve, reject) => {\r\n\t\tserver.close(e => (e ? reject(e) : resolve('ok')))\r\n\t})\r\n})\r\n"],
  "mappings": "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",
  "names": []
}
