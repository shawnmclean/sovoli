/**
 * Delete Migrated Old Media Files
 *
 * This script deletes old Cloudinary assets that were migrated to new locations.
 * It reads from a state file generated by migrate-tenant-media.mjs.
 *
 * Usage:
 *   pnpm with-env node scripts/delete-migrated-old-media.mjs <state-file-path>
 *
 * Example:
 *   pnpm with-env node scripts/delete-migrated-old-media.mjs \
 *     "scripts/healingemeraldwellness-migration-old-files.json"
 *
 * Arguments:
 *   <state-file-path>  - Path to the JSON state file generated by the migration script
 *
 * Output:
 *   - Deletion summary in console
 */

import { v2 as cloudinary } from "cloudinary";
import dotenv from "dotenv";
import fs from "fs";
import path from "path";

// Load environment variables from root .env file
dotenv.config({ path: path.join(process.cwd(), "../../../.env") });

// Configure Cloudinary
cloudinary.config({
  cloud_name: process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,
  api_key: process.env.CLOUDINARY_API_KEY,
  api_secret: process.env.CLOUDINARY_API_SECRET,
});

// Get command line arguments
const [stateFilePath] = process.argv.slice(2);

if (!stateFilePath) {
  console.error("Usage: node delete-migrated-old-media.mjs <state-file-path>");
  console.error(
    'Example: node delete-migrated-old-media.mjs "scripts/healingemeraldwellness-migration-old-files.json"',
  );
  process.exit(1);
}

/** @type {string} */
const stateFilePathStr = stateFilePath;

/**
 * Detect resource type from publicId or try both
 * @param {string} publicId - The Cloudinary public ID of the asset to delete
 */
async function deleteAsset(publicId) {
  // TypeScript: ensure this is a string
  /** @type {string} */
  const publicIdStr = publicId;

  // Try image first (most common)
  try {
    const result = await cloudinary.uploader.destroy(publicIdStr, {
      resource_type: "image",
      invalidate: true,
    });

    if (result.result === "ok") {
      return { success: true, resourceType: "image" };
    }
  } catch (error) {
    // If image fails, try video
    if (error.message && error.message.includes("not found")) {
      try {
        const result = await cloudinary.uploader.destroy(publicIdStr, {
          resource_type: "video",
          invalidate: true,
        });

        if (result.result === "ok") {
          return { success: true, resourceType: "video" };
        }
      } catch (videoError) {
        return { success: false, error: videoError.message };
      }
    }
    return { success: false, error: error.message };
  }

  // If we get here, it might be "not found" for image
  // Try video as fallback
  try {
    const result = await cloudinary.uploader.destroy(publicIdStr, {
      resource_type: "video",
      invalidate: true,
    });

    if (result.result === "ok") {
      return { success: true, resourceType: "video" };
    }
    return { success: false, error: `Result: ${result.result}` };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

async function deleteOldMedia() {
  try {
    console.log(`\n=== Deleting Old Migrated Media Files ===\n`);

    // Resolve state file path
    let stateFileFullPath = path.isAbsolute(stateFilePathStr)
      ? stateFilePathStr
      : path.resolve(process.cwd(), stateFilePathStr);

    // If file doesn't exist, try resolving from workspace root
    if (!fs.existsSync(stateFileFullPath)) {
      const workspaceRoot = path.resolve(process.cwd(), "../../../");
      const altPath = path.resolve(workspaceRoot, stateFilePathStr);
      if (fs.existsSync(altPath)) {
        stateFileFullPath = altPath;
      }
    }

    if (!fs.existsSync(stateFileFullPath)) {
      throw new Error(`State file not found: ${stateFileFullPath}`);
    }

    console.log(`Reading state file from: ${stateFileFullPath}`);

    // Read state file
    const stateFileContent = fs.readFileSync(stateFileFullPath, "utf8");
    const stateData = JSON.parse(stateFileContent);

    if (!stateData.oldPublicIds || !Array.isArray(stateData.oldPublicIds)) {
      throw new Error("Invalid state file format: missing 'oldPublicIds' array");
    }

    const tenantUsername = stateData.tenantUsername || "unknown";
    const oldPublicIds = stateData.oldPublicIds;
    const migratedAt = stateData.migratedAt || "unknown";

    console.log(`Tenant: ${tenantUsername}`);
    console.log(`Migration date: ${migratedAt}`);
    console.log(`Files to delete: ${oldPublicIds.length}\n`);

    if (oldPublicIds.length === 0) {
      console.log("✅ No files to delete!");
      return;
    }

    // Confirm deletion
    console.log("⚠️  WARNING: This will permanently delete the following files from Cloudinary:");
    oldPublicIds.forEach((id, index) => {
      console.log(`  ${index + 1}. ${id}`);
    });
    console.log("\nPress Ctrl+C to cancel, or wait 5 seconds to continue...\n");

    // Wait 5 seconds
    await new Promise((resolve) => setTimeout(resolve, 5000));

    // Delete each file
    const deletionResults = [];

    for (let i = 0; i < oldPublicIds.length; i++) {
      const publicId = oldPublicIds[i];
      console.log(`\n[${i + 1}/${oldPublicIds.length}] Deleting: ${publicId}`);

      const result = await deleteAsset(publicId);

      if (result.success) {
        console.log(`  ✅ Deleted successfully (${result.resourceType})`);
        deletionResults.push({
          publicId,
          success: true,
          resourceType: result.resourceType,
        });
      } else {
        console.log(`  ❌ Failed: ${result.error}`);
        deletionResults.push({
          publicId,
          success: false,
          error: result.error,
        });
      }
    }

    // Print summary
    console.log(`\n\n=== Deletion Summary ===`);
    console.log(`Total files: ${oldPublicIds.length}`);
    console.log(`Successfully deleted: ${deletionResults.filter((r) => r.success).length}`);
    console.log(`Failed: ${deletionResults.filter((r) => !r.success).length}`);

    if (deletionResults.some((r) => !r.success)) {
      console.log(`\n⚠️  Some files failed to delete. Check the errors above.`);
    } else {
      console.log(`\n✅ All files deleted successfully!`);
    }
  } catch (error) {
    console.error("\n❌ Deletion failed:", error);
    process.exit(1);
  }
}

deleteOldMedia().catch(console.error);
